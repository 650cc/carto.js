<!DOCTYPE html>
<html>
  <head>
    <title>Praxy_v0.1</title>
    <meta name="viewport" content="initial-scale=1.0"></meta>
    <meta charset="utf-8"></meta>
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="../../../dist/public/carto.js"></script>

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="./chart.js"></script>

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type='text/css'></link>
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type='text/css'></link>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet"></link>
    <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet"></link>
    <link href="./style.css" rel="stylesheet" type='text/css'></link>

    </head>
    <body>
    <div id="container">
      <div id="map"></div>

      <div id="widgets">
        <div class="widget-container" id="menu"></div>
        <select id="operation" class="select">
           <option value="sum" id="avg">SUM</option>
           <option value="count" id="min">COUNT</option>
           <option value="avg" id="max">AVG</option>
           <option value="max" id="sum">MAX</option>
           <option value="min" id="count">MIN</option>
         </select>
        <button onclick="selectDataviewChanges()" class="button">Apply</button>
        <div class="widget-container" id="widget1"></div>
        <div class="widget-container" id="widget2"><div class="info" id="content"></div></div>
       </div>
     </div>
    </div>
    <script>
      console.log(carto.version)

      const map = L.map('map').setView([48, 2], 8);
      // Adding Voyager Basemap
      L.tileLayer('https://api.mapbox.com/styles/v1/sducournau/cjfmqj0r517kr2snx3htweipo/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoic2R1Y291cm5hdSIsImEiOiJjajk5dDRiamQxMTVsMzB0NGw4ZmVtZWVrIn0.xdXP6dldSqtgXbk-SR3lOw', {
        maxZoom: 24
      }).addTo(map);
      const client = new carto.Client({
        apiKey: '0c35d633c804f347ffd0247924c87856c5f29418',
        username: 'simon-d'
      });

      const entreprisesSource = new carto.source.Dataset(`
        teset
      `);

      const source = new carto.source.Dataset(`
        teset
      `);
      const entreprisesStyle = new carto.style.CartoCSS(`
        #layer {
          marker-width: ramp([tca], range(5, 20), jenks(5));
          marker-fill: ramp([secteur], ( '#ffaf40','#17c0eb', '#ff3838', '#38ada9', '#b8e994', '#7158e2'), category);
          marker-fill-opacity: 0.8;
          marker-allow-overlap: false;
          marker-line-width: 0;
          marker-line-color: #FFFFFF;
          marker-line-opacity: 1;}
      `);

      const entreprises = new carto.layer.Layer(entreprisesSource, entreprisesStyle, {
        featureOverColumns: ['denomination','secteur'], featureClickColumns: ['lien_google','libelle_ape___activite','ca_2012','ca_2013','ca_2014','ca_2015','ca_2016','denomination','ville', 'ca_moyen']
      });

      console.log(entreprises);

      const popup = L.popup({ closeButton: false });

      client.addLayer(entreprises);
      client.getLeafletLayer().addTo(map);


      let data_ca2012 = null,
          data_ca2013 = null,
          data_ca2014 = null,
          data_ca2015 = null,
          data_ca2016 = null;

      let operation = 'avg';

      const dataview_ca2012 = new carto.dataview.Category(entreprisesSource, 'secteur', { limit: 7, operation: operation, operationColumn: 'ca_2012' });
      const dataview_ca2013 = new carto.dataview.Category(entreprisesSource, 'secteur', { limit: 7, operation: operation, operationColumn: 'ca_2013' });
      const dataview_ca2014 = new carto.dataview.Category(entreprisesSource, 'secteur', { limit: 7, operation: operation, operationColumn: 'ca_2014' });
      const dataview_ca2015 = new carto.dataview.Category(entreprisesSource, 'secteur', { limit: 7, operation: operation, operationColumn: 'ca_2015' });
      const dataview_ca2016 = new carto.dataview.Category(entreprisesSource, 'secteur', { limit: 7, operation: operation, operationColumn: 'ca_2016' });

      dataview_ca2012.on('error', error => {
        alert(error.message);
      });

      dataview_ca2012.on('dataChanged', newData => {
        data_ca2012 = newData;
        onDataChanged();
      });

      dataview_ca2013.on('dataChanged', newData => {
        data_ca2013 = newData;
        onDataChanged();
      });

      dataview_ca2014.on('dataChanged', newData => {
        data_ca2014 = newData;
        onDataChanged();
      });

      dataview_ca2015.on('dataChanged', newData => {
        data_ca2015 = newData;
        onDataChanged();
      });

      dataview_ca2016.on('dataChanged', newData => {
        data_ca2016 = newData;
        onDataChanged();
      });

      function onDataChanged() {
        if (!data_ca2012 || !data_ca2013 || !data_ca2014 || !data_ca2015 || !data_ca2016) {
          return;
        }
        d3.select("#infofiche").remove();
        var chart = initVizu ();

        data_ca2012 = data_ca2012.categories
        .map(category => {
          return {
            secteur: category.name,
            ca: category.value
          }
        })

        data_ca2013 = data_ca2013.categories
        .map(category => {
          return {
            secteur: category.name,
            ca: category.value
          }
        })

        data_ca2014 = data_ca2014.categories
        .map(category => {
          return {
            secteur: category.name,
            ca: category.value
          }
        })

        data_ca2015 = data_ca2015.categories
        .map(category => {
          return {
            secteur: category.name,
            ca: category.value
          }
        })

        data_ca2016 = data_ca2016.categories
        .map(category => {
          return {
            secteur: category.name,
            ca: category.value
          }
        })

        var data = data_ca2012.map((category, i) => {
          return {
            secteur: data_ca2012[i].secteur,
            ca2012: data_ca2012[i].ca,
            ca2013: data_ca2013[i].ca,
            ca2014: data_ca2014[i].ca,
            ca2015: data_ca2015[i].ca,
            ca2016: data_ca2016[i].ca
          }
        });

        data_ca2012 = data_ca2013 = data_ca2014 = data_ca2015 = data_ca2016 = null;
        vizu(data, chart);
      }

      entreprises.on('featureOver', featureEvent => {
        popup.setLatLng(featureEvent.latLng);

        if (!popup.isOpen()) {
            popup.setContent(featureEvent.data.denomination);
            popup.openOn(map);
          }
        });

      entreprises.on('featureOut', featureEvent => {
        popup.removeFrom(map);
      });

      entreprises.on('featureClicked', featureEvent => {
        var chart = initVizu ();
        let content = '';
        content += `<div id="infofiche">`;
        content += `<h5>${featureEvent.data.denomination}</h5>`;
        content += `<h5>${featureEvent.data.ville}</h5>`;
        content += `<p>${featureEvent.data.libelle_ape___activite}</p>`;

        content += `<p>${featureEvent.data.ca_moyen} <small> â‚¬ CA moyen</small></p>`;

        content += `<a class="lien_google" target="_blank" style="font-size:140%;" href="${featureEvent.data.lien_google}"><img src="https://www.google.fr/images/branding/googlelogo/2x/googlelogo_color_120x44dp.png" style="width:30%;height:30%;border:0;"></a>`;
        content += `</div>`;
        document.getElementById('content').innerHTML = content;
        var data = [{
          secteur: featureEvent.data.secteur,
          ca2012: featureEvent.data.ca_2012,
          ca2013: featureEvent.data.ca_2013,
          ca2014: featureEvent.data.ca_2014,
          ca2015: featureEvent.data.ca_2015,
          ca2016: featureEvent.data.ca_2016
        }];

        vizu(data, chart);
      });

      const bboxFilter = new carto.filter.BoundingBoxLeaflet(map);
      client.addDataviews([dataview_ca2012, dataview_ca2013, dataview_ca2014, dataview_ca2015, dataview_ca2016]);
      dataview_ca2012.addFilter(bboxFilter);
      dataview_ca2013.addFilter(bboxFilter);
      dataview_ca2014.addFilter(bboxFilter);
      dataview_ca2015.addFilter(bboxFilter);
      dataview_ca2016.addFilter(bboxFilter);

      function selectDataviewChanges() {
        const operation = document.getElementById('operation').value;
        const dataviews = [dataview_ca2012, dataview_ca2013, dataview_ca2014, dataview_ca2015, dataview_ca2016];
        dataviews.forEach((dataview) => {
          dataview.setOperation(operation);
        });

        console.log(dataview_ca2012);
      }
    </script>
  </body>
</html>